<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Raw Previewer</title>
  <script>
  
var fs={};
var readFileStore = [];
fs.readFile = function (file,cb){
  if(!(readFileStore.includes(file))){    
    var rawFile = new XMLHttpRequest();
    //rawFile.overrideMimeType('text/plain; charset=utf-8');
    rawFile.open("GET", file, false);
    rawFile.onload = function () {
      if(rawFile.readyState === 4) {
        if(rawFile.status === 200 || rawFile.status == 0) {
         cb(rawFile.responseText)
        }
      }
    }
    rawFile.send(null);
  }
};    

var readFileSyncStore = [];
fs.readFileSync = function readFileSync(filePath) {
  if(!(readFileSyncStore.includes(filePath))){
    readFileSyncStore.push(filePath);
    let result = null;
    const xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", filePath, false);
    xmlhttp.send();
        result = xmlhttp.responseText;
        console.log(`loaded : ${filePath}`);
    return result;
  }
};

var param = location.search.substring(1);

var FileRaw = param.replace(/\/\/github\.com/, '//raw.githubusercontent.com').replace(/\/blob\//, '/');

var defaultRaw = "https://github.com/dirkncl/myfirst-gh-page/blob/gh-pages/index.html".replace(/\/\/github\.com/, '//raw.githubusercontent.com').replace(/\/blob\//, '/');
var FileRaw = FileRaw||defaultRaw;

var fileName = FileRaw.split('/').pop();

var basePath = FileRaw.replace(fileName,'');

window.onload = function(){
  fs.readFile(FileRaw,function (data){
  data = data.replace(/<head>/i, '<head><base href="' + basePath + '">');
  var preview = document.createElement('div');
  preview.id = "preview";
  preview.style.display="none";
  document.body.appendChild(preview);
  preview.innerHTML = data;
       
		if (preview.querySelectorAll('frameset').length)
			return;
		var frame = preview.querySelectorAll('iframe[src],frame[src]');
		for (var i = 0; i < frame.length; ++i) {
			var src = frame[i].src;
			if (src.indexOf('//raw.githubusercontent.com') > 0) { 
				frame[i].src = 'https://' + location.hostname + location.pathname + '?' + src;
			}
		}

    var a = document.getElementById("preview").querySelectorAll('a[href]');
		for (var i = 0; i < a.length; ++i) {
			var href = a[i].href;
			if (href.indexOf('#') > 0) {
				a[i].href = 'https://' + location.hostname + location.pathname + location.search + '#' + a[i].hash.substring(1);
			}
      else if ((href.indexOf('//raw.githubusercontent.com') > 0) && (href.indexOf('.html') > 0 || href.indexOf('.htm') > 0)) {
				a[i].href = 'https://' + location.hostname + location.pathname + '?' + href;
			}
		}

    var links = []; 
		var link = preview.querySelectorAll('link[rel=stylesheet]');
		for (var i = 0; i < link.length; ++i) {
			var href = link[i].href;
			if (href.indexOf('//raw.githubusercontent.com') > 0) {
				links.push(fs.readFileSync(href));
			}
		}
    var style=[];
		for (var i = 0; i < link.length; ++i) {
      style[i] = document.createElement('style');
			style[i].innerHTML = links[i];
			document.head.appendChild(style[i]);
		}
    
		
    var scripts = [];
		var script = preview.querySelectorAll('script');
		for (var i = 0; i < script.length; ++i) {
			var src = script[i].src;
			if (src.indexOf('//raw.githubusercontent.com') > 0) {
				scripts.push(fs.readFileSync(src)); 
			} else {
				script[i].removeAttribute('type');
				scripts.push(script[i].innerHTML);
			}
		}
		var _script=[];
		for (var i = 0; i < scripts.length; ++i) {
     //console.log(scripts[i])
		eval.apply( window, [scripts[i]] );	
      _script[i] = document.createElement('script');
			_script[i].innerHTML = scripts[i];
			document.body.appendChild(_script[i]);
			
		}
		
  document.body.innerHTML=preview.innerHTML  
  })
}
  </script>
</head>
<body>

</body>
</html>
